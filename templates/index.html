<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="A simple Dropbox clone application">
  <title>Dropbox Clone</title>
  <link rel="stylesheet" href="/static/style.css">
</head>
<body>
  <header>
    <h1>Dropbox Clone</h1>
  </header>
  <main>
    <div id="auth-section">
      <p><strong>Status:</strong> <span id="user-status">Not logged in</span></p>
      <button id="logout-btn" style="display: none;">Logout</button>

      <h2>Register</h2>
      <form action="/signup" method="POST">
        <input type="email" name="email" placeholder="Email" required />
        <input type="password" name="password" placeholder="Password" required />
        <input type="hidden" id="user-id" value="" />
        <button type="submit">Sign Up</button>
      </form>

      <h2>Login</h2>
      <form id="login-form">
        <input type="email" id="login-email" placeholder="Email" required />
        <input type="password" id="login-password" placeholder="Password" required />
        <button type="submit">Log In</button>
      </form>

      <hr>
      <h2>Manage Directories</h2>
      <form id="create-directory-form">
        <input type="text" id="dir-name" placeholder="Directory name" required />
        <input type="hidden" id="user-id" value="" />
        <button type="submit">Create Directory</button>
      </form>

      <form id="delete-directory-form" style="margin-top: 1rem;">
        <input type="text" id="delete-path" placeholder="Path to delete (e.g. /myfolder)" required />
        <button type="submit">Delete Directory</button>
      </form>

      <div id="directory-message"></div>

      <script>
        const logoutBtn = document.getElementById("logout-btn");
        logoutBtn.addEventListener("click", () => {
          // ✅ Reset status
          document.getElementById("user-status").textContent = "Not logged in";

          // ✅ Clear and re-enable login fields
          const emailInput = document.getElementById("login-email");
          const passwordInput = document.getElementById("login-password");
          const loginBtn = document.querySelector("#login-form button");

          emailInput.value = "";
          passwordInput.value = "";
          emailInput.disabled = false;
          passwordInput.disabled = false;
          loginBtn.disabled = false;

          // ✅ Clear user ID field
          document.getElementById("user-id").value = "";

          // ✅ Hide logout button again
          logoutBtn.style.display = "none";
        });

        document.getElementById("login-form").addEventListener("submit", async (e) => {
          e.preventDefault();

          const email = document.getElementById("login-email").value;
          const password = document.getElementById("login-password").value;

          const response = await fetch("/login", {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: `email=${encodeURIComponent(email)}&password=${encodeURIComponent(password)}`
          });

          const result = await response.json();

          if (result.uid) {

            document.getElementById("user-status").textContent = `Logged in as ${email}`;
            document.getElementById("user-id").value = result.uid;
            logoutBtn.style.display = "inline-block"; // ✅ Show logout

            // ✅ Clear fields
            document.getElementById("login-email").value = "";
            document.getElementById("login-password").value = "";




            // ✅ Disable login form after success
            document.getElementById("login-email").disabled = true;
            document.getElementById("login-password").disabled = true;
            e.target.querySelector("button").disabled = true;
          } else {
            alert("Login failed: " + result.error);
          }
        });

        document.getElementById("create-directory-form").addEventListener("submit", async (e) => {
          e.preventDefault();
          const name = document.getElementById("dir-name").value;
          const uid = document.getElementById("user-id").value;

          const response = await fetch("/directory", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ uid, name, parent_path: "/" })
          });

          const result = await response.json();
          document.getElementById("directory-message").textContent = result.message;
        });

        document.getElementById("delete-directory-form").addEventListener("submit", async (e) => {
          e.preventDefault();
          const uid = document.getElementById("user-id").value;
          const path = document.getElementById("delete-path").value;

          const response = await fetch("/directory", {
            method: "DELETE",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ uid, path })
          });

          const result = await response.json();
          document.getElementById("directory-message").textContent = result.message;
        });
      </script>
    </div>
  </main>
</body>
</html>